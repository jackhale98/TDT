{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://pdt.dev/schemas/dev.schema.json",
  "title": "DEV",
  "description": "A process deviation (pre-approved departure from standard process)",
  "type": "object",
  "required": ["id", "title", "status", "created", "author"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^DEV-[0-9A-Z]{26}$",
      "description": "Unique identifier (DEV prefix + ULID)"
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "maxLength": 200,
      "description": "Short descriptive title"
    },
    "deviation_number": {
      "type": ["string", "null"],
      "description": "User-defined deviation number (e.g., DEV-2024-042)"
    },
    "deviation_type": {
      "type": "string",
      "enum": ["temporary", "permanent", "emergency"],
      "default": "temporary",
      "description": "Type of deviation"
    },
    "category": {
      "type": "string",
      "enum": ["material", "process", "equipment", "tooling", "specification", "documentation"],
      "default": "material",
      "description": "Category of deviation"
    },
    "description": {
      "type": ["string", "null"],
      "description": "Detailed description of the deviation"
    },
    "risk": {
      "type": "object",
      "properties": {
        "level": {
          "type": "string",
          "enum": ["low", "medium", "high"],
          "default": "low",
          "description": "Risk level of the deviation"
        },
        "assessment": {
          "type": ["string", "null"],
          "description": "Risk assessment text"
        },
        "mitigations": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Mitigation measures"
        }
      },
      "description": "Risk assessment for the deviation"
    },
    "approval": {
      "type": "object",
      "properties": {
        "approved_by": {
          "type": ["string", "null"],
          "description": "Who approved the deviation"
        },
        "approval_date": {
          "type": ["string", "null"],
          "format": "date",
          "description": "Date of approval"
        },
        "authorization_level": {
          "type": ["string", "null"],
          "enum": ["engineering", "quality", "management", null],
          "description": "Level of authorization required"
        }
      },
      "description": "Approval information"
    },
    "effective_date": {
      "type": ["string", "null"],
      "format": "date",
      "description": "Date the deviation becomes effective"
    },
    "expiration_date": {
      "type": ["string", "null"],
      "format": "date",
      "description": "Date the deviation expires (null for permanent)"
    },
    "dev_status": {
      "type": "string",
      "enum": ["pending", "approved", "active", "expired", "closed", "rejected"],
      "default": "pending",
      "description": "Workflow status of the deviation"
    },
    "notes": {
      "type": ["string", "null"],
      "description": "Additional notes"
    },
    "links": {
      "type": "object",
      "properties": {
        "processes": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Affected process entities"
        },
        "lots": {
          "type": "array",
          "items": { "type": "string" },
          "description": "LOT entities this applies to"
        },
        "components": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Affected component entities"
        },
        "requirements": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Requirements being deviated from"
        },
        "ncrs": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Related NCRs (if deviation arose from NCR)"
        },
        "change_order": {
          "type": ["string", "null"],
          "description": "ECO/DCN reference if permanent"
        }
      }
    },
    "status": {
      "type": "string",
      "enum": ["draft", "review", "approved", "released", "obsolete"],
      "description": "Document status"
    },
    "created": {
      "type": "string",
      "format": "date-time",
      "description": "Creation timestamp"
    },
    "author": {
      "type": "string",
      "description": "Author name"
    },
    "entity_revision": {
      "type": "integer",
      "minimum": 1,
      "default": 1,
      "description": "Entity revision number"
    }
  },
  "additionalProperties": true
}
